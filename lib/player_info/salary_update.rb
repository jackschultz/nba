require 'csv'

module PlayerInfo
  class SalaryUpdate

    def self.update_draft_kings(date=nil)
      date ||= Date.today

      team_avgs = {}
      nba_avgs = {}
=begin
      nba_avgs = Team.nba_average_pgbp(date)

      team_avgs = {}
      Game.on_date(date).each do |g|
        team_avgs[g.home_team_id] = g.home_team.points_given_by_position(date)
        team_avgs[g.away_team_id] = g.away_team.points_given_by_position(date)
      end
=end

=begin TODO dates for 11/13/14
      nba_avgs = {"PG"=>38.0182705026455, "SG"=>32.80001653439153, "SF"=>29.517923280423286, "PF"=>34.3322585978836, "C"=>31.78369708994709}

      team_avgs = {3=>{"PG"=>29.8125, "SG"=>34.3125, "SF"=>13.96875, "PF"=>43.40625, "C"=>26.5625},
 8=>{"PG"=>35.40625, "SG"=>22.21875, "SF"=>15.375, "PF"=>34.5625, "C"=>32.1875},
 25=>{"PG"=>42.03125, "SG"=>21.375, "SF"=>35.78125, "PF"=>25.09375, "C"=>38.28125},
 17=>{"PG"=>39.96875, "SG"=>23.34375, "SF"=>45.1875, "PF"=>23.5, "C"=>33.15625},
 27=>{"PG"=>45.375, "SG"=>46.875, "SF"=>32.90625, "PF"=>48.28125, "C"=>27.8125},
 11=>{"PG"=>40.035714285714285, "SG"=>41.357142857142854, "SF"=>42.714285714285715, "PF"=>17.142857142857142, "C"=>31.107142857142858},
 29=>{"PG"=>39.107142857142854, "SG"=>38.107142857142854, "SF"=>26.357142857142858, "PF"=>36.0, "C"=>18.107142857142858},
 14=>{"PG"=>38.67857142857143, "SG"=>34.892857142857146, "SF"=>27.607142857142858, "PF"=>32.785714285714285, "C"=>28.821428571428573}}

=begin TODO dates for 11/12/14
      nba_avgs = {"PG"=>37.05381944444444, "SG"=>31.83144841269841, "SF"=>29.444394841269844, "PF"=>33.69578373015873, "C"=>31.05659722222222}

team_avgs = {26=>{"PG"=>38.464285714285715, "SG"=>23.642857142857142, "SF"=>31.178571428571427, "PF"=>33.5, "C"=>29.107142857142858},
 19=>{"PG"=>36.357142857142854, "SG"=>38.107142857142854, "SF"=>25.392857142857142, "PF"=>38.57142857142857, "C"=>31.892857142857142},
 15=>{"PG"=>28.333333333333332, "SG"=>38.333333333333336, "SF"=>28.666666666666668, "PF"=>41.666666666666664, "C"=>31.916666666666668},
 10=>{"PG"=>36.78125, "SG"=>21.28125, "SF"=>32.21875, "PF"=>42.375, "C"=>33.40625},
 13=>{"PG"=>29.666666666666668, "SG"=>24.125, "SF"=>29.041666666666668, "PF"=>36.708333333333336, "C"=>31.041666666666668},
 6=>{"PG"=>40.3125, "SG"=>35.125, "SF"=>24.84375, "PF"=>28.46875, "C"=>37.1875},
 21=>{"PG"=>34.142857142857146, "SG"=>22.821428571428573, "SF"=>26.607142857142858, "PF"=>24.785714285714285, "C"=>33.5},
 20=>{"PG"=>44.84375, "SG"=>31.84375, "SF"=>23.65625, "PF"=>26.75, "C"=>32.46875},
 23=>{"PG"=>39.375, "SG"=>35.5, "SF"=>32.5, "PF"=>28.90625, "C"=>25.4375},
 24=>{"PG"=>46.4375, "SG"=>37.34375, "SF"=>28.59375, "PF"=>44.3125, "C"=>27.65625},
 5=>{"PG"=>44.583333333333336, "SG"=>36.416666666666664, "SF"=>45.041666666666664, "PF"=>40.166666666666664, "C"=>37.291666666666664},
 2=>{"PG"=>39.0, "SG"=>40.25, "SF"=>22.571428571428573, "PF"=>34.642857142857146, "C"=>37.964285714285715},
 28=>{"PG"=>19.333333333333332, "SG"=>26.291666666666668, "SF"=>34.083333333333336, "PF"=>39.541666666666664, "C"=>41.375},
 12=>{"PG"=>31.875, "SG"=>26.125, "SF"=>27.40625, "PF"=>23.5625, "C"=>29.9375},
 7=>{"PG"=>33.92857142857143, "SG"=>40.214285714285715, "SF"=>23.071428571428573, "PF"=>33.5, "C"=>24.035714285714285},
 14=>{"PG"=>35.0, "SG"=>30.583333333333332, "SF"=>32.208333333333336, "PF"=>30.75, "C"=>27.583333333333332},
 4=>{"PG"=>32.5, "SG"=>34.25, "SF"=>38.458333333333336, "PF"=>18.291666666666668, "C"=>28.791666666666668},
 30=>{"PG"=>39.25, "SG"=>17.321428571428573, "SF"=>31.75, "PF"=>26.107142857142858, "C"=>23.107142857142858}}
=end

=begin TODO dates for 11/11/14
  nba_avgs = {"PG"=>36.594990079365076, "SG"=>31.18864087301587, "SF"=>28.997916666666665, "PF"=>33.348462301587304, "C"=>30.941815476190474}

  team_avgs = {25=>{"PG"=>44.17857142857143, "SG"=>18.321428571428573, "SF"=>32.92857142857143, "PF"=>23.071428571428573, "C"=>36.82142857142857},
 24=>{"PG"=>46.0, "SG"=>38.535714285714285, "SF"=>25.464285714285715, "PF"=>45.035714285714285, "C"=>29.785714285714285},
 3=>{"PG"=>29.928571428571427, "SG"=>31.321428571428573, "SF"=>12.821428571428571, "PF"=>35.642857142857146, "C"=>29.642857142857142},
 2=>{"PG"=>36.083333333333336, "SG"=>35.916666666666664, "SF"=>26.333333333333332, "PF"=>35.333333333333336, "C"=>36.0},
 22=>{"PG"=>31.5, "SG"=>21.428571428571427, "SF"=>23.107142857142858, "PF"=>33.642857142857146, "C"=>29.178571428571427},
 6=>{"PG"=>39.142857142857146, "SG"=>32.035714285714285, "SF"=>24.892857142857142, "PF"=>30.178571428571427, "C"=>36.07142857142857},
 27=>{"PG"=>47.857142857142854, "SG"=>49.42857142857143, "SF"=>29.071428571428573, "PF"=>50.785714285714285, "C"=>26.392857142857142},
 8=>{"PG"=>33.92857142857143, "SG"=>21.178571428571427, "SF"=>12.285714285714286, "PF"=>31.25, "C"=>31.678571428571427},
 12=>{"PG"=>30.464285714285715, "SG"=>21.714285714285715, "SF"=>27.392857142857142, "PF"=>23.75, "C"=>30.642857142857142},
 16=>{"PG"=>40.964285714285715, "SG"=>35.0, "SF"=>16.857142857142858, "PF"=>31.714285714285715, "C"=>25.035714285714285},
 29=>{"PG"=>35.416666666666664, "SG"=>36.708333333333336, "SF"=>25.041666666666668, "PF"=>30.083333333333332, "C"=>19.625},
 9=>{"PG"=>38.333333333333336, "SG"=>39.041666666666664, "SF"=>15.083333333333334, "PF"=>52.083333333333336, "C"=>38.958333333333336}}

=end

=begin TODO dates for 11/10/14
      nba_avgs = {"PG"=>36.255634920634925, "SG"=>31.305674603174605, "SF"=>28.76904761904762, "PF"=>32.31472222222223, "C"=>30.889444444444447}

      team_avgs = {18=>{"PG"=>38.35, "SG"=>35.85, "SF"=>46.45, "PF"=>33.25, "C"=>34.5},
 5=>{"PG"=>42.2, "SG"=>42.05, "SF"=>35.65, "PF"=>37.35, "C"=>39.8},
 20=>{"PG"=>46.32142857142857, "SG"=>26.892857142857142, "SF"=>26.142857142857142, "PF"=>25.285714285714285, "C"=>32.17857142857143},
 10=>{"PG"=>37.035714285714285, "SG"=>24.321428571428573, "SF"=>33.785714285714285, "PF"=>42.17857142857143, "C"=>25.464285714285715},
 23=>{"PG"=>39.642857142857146, "SG"=>34.214285714285715, "SF"=>33.42857142857143, "PF"=>26.821428571428573, "C"=>24.142857142857142},
 15=>{"PG"=>29.6, "SG"=>32.55, "SF"=>24.4, "PF"=>46.4, "C"=>34.35},
 17=>{"PG"=>37.75, "SG"=>24.928571428571427, "SF"=>40.32142857142857, "PF"=>22.357142857142858, "C"=>35.107142857142854},
 19=>{"PG"=>31.958333333333332, "SG"=>39.958333333333336, "SF"=>26.791666666666668, "PF"=>32.0, "C"=>30.375},
 1=>{"PG"=>30.625, "SG"=>32.708333333333336, "SF"=>35.541666666666664, "PF"=>21.333333333333332, "C"=>33.541666666666664},
 9=>{"PG"=>36.4, "SG"=>43.5, "SF"=>15.25, "PF"=>51.65, "C"=>36.7}}
=end

=begin TODO dates for 11/9/14
      nba_avgs = {"PG"=>34.853293650793645, "SG"=>30.92388888888889, "SF"=>28.339166666666664, "PF"=>31.671904761904766, "C"=>30.175198412698414}

      team_avgs = {14=>{"PG"=>34.4, "SG"=>28.4, "SF"=>33.0, "PF"=>30.8, "C"=>23.3},
 24=>{"PG"=>44.916666666666664, "SG"=>33.625, "SF"=>27.041666666666668, "PF"=>47.625, "C"=>25.541666666666668},
 19=>{"PG"=>30.3, "SG"=>36.7, "SF"=>28.8, "PF"=>27.9, "C"=>29.75},
 10=>{"PG"=>34.25, "SG"=>25.833333333333332, "SF"=>31.166666666666668, "PF"=>41.083333333333336, "C"=>23.458333333333332},
 6=>{"PG"=>38.166666666666664, "SG"=>33.375, "SF"=>19.041666666666668, "PF"=>29.708333333333332, "C"=>35.875},
 8=>{"PG"=>29.458333333333332, "SG"=>19.083333333333332, "SF"=>14.333333333333334, "PF"=>29.0, "C"=>28.0},
 25=>{"PG"=>42.916666666666664, "SG"=>21.375, "SF"=>31.625, "PF"=>24.208333333333332, "C"=>38.291666666666664},
 11=>{"PG"=>38.375, "SG"=>41.166666666666664, "SF"=>40.708333333333336, "PF"=>12.916666666666666, "C"=>32.666666666666664},
 27=>{"PG"=>48.083333333333336, "SG"=>51.0, "SF"=>24.375, "PF"=>53.541666666666664, "C"=>23.791666666666668},
 21=>{"PG"=>34.625, "SG"=>21.125, "SF"=>25.083333333333332, "PF"=>19.208333333333332, "C"=>32.458333333333336},
 7=>{"PG"=>26.416666666666668, "SG"=>46.416666666666664, "SF"=>14.625, "PF"=>37.875, "C"=>23.541666666666668},
 29=>{"PG"=>28.45, "SG"=>36.6, "SF"=>30.05, "PF"=>26.3, "C"=>19.15},
 12=>{"PG"=>27.125, "SG"=>18.958333333333332, "SF"=>27.541666666666668, "PF"=>22.0, "C"=>29.291666666666668},
 28=>{"PG"=>13.0, "SG"=>22.95, "SF"=>35.05, "PF"=>36.6, "C"=>35.5},
 2=>{"PG"=>36.0, "SG"=>34.45, "SF"=>26.4, "PF"=>38.05, "C"=>36.2},
 16=>{"PG"=>36.916666666666664, "SG"=>31.875, "SF"=>17.791666666666668, "PF"=>25.0, "C"=>27.25}}


=end

      date_string = date.strftime('%F')
      site = Site.find_by_name("Draft Kings")
      filename = "lib/player_info/dk_salaries-#{date_string}.csv"
      CSV.foreach(filename, {headers: true}) do |row|
        position = row[0]
        full_name = row[1].split(' ')
        first_name = full_name[0]
        last_name = full_name[1..-1].join(' ')
        player = Player.find_by_first_name_and_last_name(first_name, last_name)
        if player.nil?
          Rails.logger.info "Cannot find player with name: #{row[1]}"
          next
        end
        game = Game.where(date: date_string).where('home_team_id=? OR away_team_id=?', player.team_id, player.team_id).first
        if game.nil?
          Rails.logger.info "Cannot find game for date #{date} and player #{player.inspect}"
          next
        end
        salary = row[2]
        sinfo = site.player_costs.where(player_id: player.id, game_id: game.id).first_or_create
        sinfo.position = position
        sinfo.salary = salary
        sinfo.save
        sinfo.expected_points = row[-1].to_f #sinfo.player.avg_draft_kings
        sinfo.save

        other_team_id = game.home_team_id == sinfo.player.team.id ? game.away_team_id : game.away_team_id

#        sinfo.set_expected_points!(date, nba_avgs, team_avgs[other_team_id], row[-1])
        generate_other_player_costs(sinfo)
      end
    end

    def self.generate_other_player_costs(pc)
      pcs_by_position = pc.site.player_costs.where(player_id: pc.player.id, game_id: pc.game.id).map(&:position)
      if pc.pg? || pc.sg? && !pcs_by_position.include?("G")
        gpc = pc.dup
        gpc.position = "G"
        gpc.save
      end
      if pc.sf? || pc.pf? && !pcs_by_position.include?("F")
        gpc = pc.dup
        gpc.position = "F"
        gpc.save
      end
      if !pcs_by_position.include?("U")
        gpc = pc.dup
        gpc.position = "U"
        gpc.save
      end
      opc = pc.site.player_costs.where(player_id: pc.player.id, game_id: pc.game.id)
      opc.each{|c| c.expected_points = pc.expected_points;c.save }
    end

  end
end
